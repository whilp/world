name: nvim

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        type: boolean
        required: false
        default: true

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: darwin-arm64
            runner: macos-latest
            asset: nvim-macos-arm64.tar.gz
          - platform: linux-arm64
            runner: ubuntu-24.04-arm
            asset: nvim-linux-arm64.tar.gz
          - platform: linux-x86_64
            runner: ubuntu-24.04
            asset: nvim-linux-x86_64.tar.gz

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Download nvim nightly
        run: |
          mkdir -p o/3p/nvim/${{ matrix.platform }}
          cd o/3p/nvim/${{ matrix.platform }}
          curl -L -o archive.tar.gz \
            https://github.com/neovim/neovim/releases/download/nightly/${{ matrix.asset }}
          tar -xzf archive.tar.gz --strip-components=1
          rm archive.tar.gz

      - name: Bundle plugins
        run: |
          make nvim-bundle-plugins PLATFORM=${{ matrix.platform }}

      - name: Create tarball
        id: tarball
        run: |
          BUILD_DATE=$(date -u +%Y.%m.%d)
          TARBALL_NAME="nvim-${BUILD_DATE}-${{ matrix.platform }}.tar.gz"

          cd o/3p/nvim
          tar -czf "${TARBALL_NAME}" ${{ matrix.platform }}

          SHA256=$(sha256sum "${TARBALL_NAME}" | awk '{print $1}')
          echo "${SHA256}  ${TARBALL_NAME}" > "${TARBALL_NAME}.sha256"

          echo "tarball=${TARBALL_NAME}" >> $GITHUB_OUTPUT
          echo "sha256_file=${TARBALL_NAME}.sha256" >> $GITHUB_OUTPUT
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: nvim-${{ matrix.platform }}
          path: |
            o/3p/nvim/${{ steps.tarball.outputs.tarball }}
            o/3p/nvim/${{ steps.tarball.outputs.sha256_file }}
          retention-days: 30

  release:
    if: github.event.inputs.create_release == 'true'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts

      - name: Get upstream nvim commit SHA
        id: nvim_sha
        run: |
          COMMIT_SHA=$(curl -sL https://api.github.com/repos/neovim/neovim/releases/tags/nightly \
            | jq -r '.target_commitish')
          SHORT_SHA=${COMMIT_SHA:0:7}
          BUILD_DATE=$(date -u +%Y.%m.%d)
          TAG="${BUILD_DATE}-${SHORT_SHA}"

          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;
          find artifacts -name '*.sha256' -exec cp {} release/ \;
          cd release
          cat *.sha256 > SHA256SUMS
          ls -lh

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd release
          gh release create "${{ steps.nvim_sha.outputs.tag }}" \
            --title "nvim nightly ${{ steps.nvim_sha.outputs.tag }}" \
            --notes "NeoVim nightly build with bundled vim.pack plugins

          Upstream commit: ${{ steps.nvim_sha.outputs.commit_sha }}
          Downloaded from: https://github.com/neovim/neovim/releases/tag/nightly

          Bundled plugins from .config/nvim/nvim-pack-lock.json:
          - conform.nvim
          - mini.nvim
          - neogit
          - nui-components.nvim
          - nui.nvim
          - nvim-lspconfig
          - nvim-treesitter
          - plenary.nvim

          Platforms:
          - darwin-arm64
          - linux-arm64
          - linux-x86_64" \
            *.tar.gz \
            *.sha256 \
            SHA256SUMS
