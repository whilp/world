name: nvim-release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., nvim-2025.01.10-abc1234)'
        required: false
        type: string

env:
  TAG_PREFIX: nvim

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: macos-latest
            platform: darwin-arm64
          - os: ubuntu-24.04-arm
            platform: linux-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - id: build-nvim-bundle
        shell: bash -x {0}
        run: |
          bin/make -j nvim-bundle

      - id: package-nvim-bundle
        shell: bash -x {0}
        run: |
          cd o/bundled
          tar -czf nvim-${{ matrix.platform }}.tar.gz nvim
          mv nvim-${{ matrix.platform }}.tar.gz ../

      - id: upload-nvim-bundle
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: nvim-${{ matrix.platform }}
          path: o/nvim-${{ matrix.platform }}.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - id: download-artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: artifacts/

      - id: create-release
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          mkdir -p release
          cp artifacts/nvim-darwin-arm64/nvim-darwin-arm64.tar.gz release/
          cp artifacts/nvim-linux-arm64/nvim-linux-arm64.tar.gz release/
          cp artifacts/nvim-linux-x86_64/nvim-linux-x86_64.tar.gz release/

          if [ -n "$INPUT_TAG" ]; then
            tag="$INPUT_TAG"
          else
            tag="${TAG_PREFIX}-$(date -u +%Y.%m.%d)-${GITHUB_SHA::7}"
          fi

          (cd release && sha256sum nvim-*.tar.gz > SHA256SUMS && cat SHA256SUMS)

          gh release create "$tag" \
            --title "nvim bundle $tag" \
            --notes "## Bundled nvim

Pre-built nvim with plugins and treesitter parsers.

### Contents
- neovim binary (custom fork)
- conform.nvim
- mini.nvim
- nvim-lspconfig
- nvim-treesitter
- Pre-compiled treesitter parsers (bash, go, javascript, json, lua, markdown, python, ruby, sql, yaml)" \
            release/nvim-*.tar.gz release/SHA256SUMS
