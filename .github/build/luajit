#!/usr/bin/env luajit

package.path = arg[0]:match("^(.*/)") .. "?.lua;" .. package.path
local util = require('util')
local versions = require('versions')

local function patch_lib_package(src_file, platform)
  util.printf("patching lib_package.c to support relocatable paths on unix...\n")

  local content = util.read_file(src_file)

  local includes_patch = [[
#if defined(__linux__) || defined(__FreeBSD__) || defined(__NetBSD__) || defined(__APPLE__)
#include <limits.h>
#if defined(__APPLE__)
#include <mach-o/dyld.h>
#endif
#endif]]

  content = content:gsub(
    '(#include "lj_obj.h")',
    '%1\n' .. includes_patch
  )

  local setprogdir_impl = [[
#if defined(__linux__) || defined(__FreeBSD__) || defined(__NetBSD__) || defined(__APPLE__)
static void setprogdir(lua_State *L)
{
  char buff[PATH_MAX + 1];
  char *lb;
  ssize_t len = -1;

#if defined(__linux__)
  len = readlink("/proc/self/exe", buff, sizeof(buff) - 1);
#elif defined(__FreeBSD__)
  len = readlink("/proc/curproc/file", buff, sizeof(buff) - 1);
#elif defined(__NetBSD__)
  len = readlink("/proc/curproc/exe", buff, sizeof(buff) - 1);
#elif defined(__APPLE__)
  uint32_t size = sizeof(buff);
  if (_NSGetExecutablePath(buff, &size) == 0) {
    len = strlen(buff);
  }
#endif

  if (len > 0 && len < (ssize_t)sizeof(buff)) {
    buff[len] = '\0';
    lb = strrchr(buff, '/');
    if (lb != NULL) {
      *lb = '\0';
      luaL_gsub(L, lua_tostring(L, -1), LUA_EXECDIR, buff);
      lua_remove(L, -2);
    }
  }
}
#else
#define setprogdir(L) ((void)0)
#endif]]

  content = content:gsub(
    '#define setprogdir%(L%)%s+%(%s*%(void%)0%s*%)',
    setprogdir_impl
  )

  util.write_file(src_file, content)
end

local function patch_luaconf(conf_file, platform)
  util.printf("patching luaconf.h to use ! paths...\n")

  local content = util.read_file(conf_file)

  local lua_path_default = [[#define LUA_PATH_DEFAULT "./?.lua;!/../share/luajit-2.1/?.lua;!/../share/lua/5.1/?.lua;!/../share/lua/5.1/?/init.lua"]]

  local lua_cpath_default = [[#define LUA_CPATH_DEFAULT "./?.so;!/../lib/lua/5.1/?.so"]]

  content = content:gsub(
    '#define LUA_PATH_DEFAULT[^\n]*',
    lua_path_default
  )

  content = content:gsub(
    '#define LUA_CPATH_DEFAULT[^\n]*',
    lua_cpath_default
  )

  util.write_file(conf_file, content)
end

local function build_luajit(config)
  util.printf("building luajit %s for %s\n", config.versions.luajit, config.platform.platform)
  util.printf("temporary directory: %s\n", config.temp_dir)
  util.printf("output directory: %s\n", config.output_dir)

  util.printf("cloning luajit repository...\n")
  local luajit_dir = config.temp_dir .. "/luajit"
  util.exec(string.format("git clone https://luajit.org/git/luajit.git %s", luajit_dir))

  util.printf("checking out %s...\n", config.versions.luajit)
  util.exec(string.format("cd %s && git checkout %s", luajit_dir, config.versions.luajit))

  local commit_hash = util.capture(string.format("cd %s && git rev-parse --short HEAD", luajit_dir))
  local commit_date = util.capture(string.format("cd %s && git log -1 --format=%%cd --date=format:%%Y.%%m.%%d", luajit_dir))
  local source_date_epoch = util.capture(string.format("cd %s && git log -1 --format=%%ct", luajit_dir))

  config.commit_hash = commit_hash
  config.build_date = commit_date
  config.source_date_epoch = source_date_epoch

  patch_lib_package(luajit_dir .. "/src/lib_package.c", config.platform)
  patch_luaconf(luajit_dir .. "/src/luaconf.h", config.platform)

  util.printf("building luajit...\n")
  local install_dir = config.temp_dir .. "/install"
  local build_env = string.format("SOURCE_DATE_EPOCH=%s TZ=UTC", source_date_epoch)

  if config.platform.is_darwin then
    build_env = build_env .. " MACOSX_DEPLOYMENT_TARGET=11.0"
  end

  local xcflags = "-DLUAJIT_ENABLE_GC64"
  local ldflags = ""

  if config.platform.is_linux then
    ldflags = "TARGET_LDFLAGS='-Wl,--build-id=none'"
  end

  util.exec(string.format(
    "cd %s && %s make amalg PREFIX=%s XCFLAGS='%s' %s",
    luajit_dir, build_env, install_dir, xcflags, ldflags
  ))

  util.printf("installing to temporary location...\n")
  util.exec(string.format("cd %s && TZ=UTC make install PREFIX=%s", luajit_dir, install_dir))

  util.printf("installing luarocks...\n")
  local luarocks_dir = config.temp_dir .. "/luarocks"
  util.exec(string.format("cd %s && git clone https://github.com/luarocks/luarocks.git", config.temp_dir))
  util.exec(string.format(
    "cd %s && ./configure --prefix=%s --with-lua=%s --lua-suffix=jit",
    luarocks_dir, install_dir, install_dir
  ))
  util.exec(string.format("cd %s && make && make install", luarocks_dir))

  local openssl_flags = ""
  local sqlite_flags = ""

  if config.platform.is_darwin then
    local openssl_prefix = util.capture("brew --prefix openssl@3")
    local sqlite_prefix = util.capture("brew --prefix sqlite")
    openssl_flags = string.format("OPENSSL_DIR=%s CRYPTO_DIR=%s", openssl_prefix, openssl_prefix)
    sqlite_flags = string.format(
      "SQLITE_DIR=%s SQLITE_INCDIR=%s/include SQLITE_LIBDIR=%s/lib",
      sqlite_prefix, sqlite_prefix, sqlite_prefix
    )
  else
    sqlite_flags = "SQLITE_INCDIR=/usr/include SQLITE_LIBDIR=/usr/lib"
  end

  util.printf("installing dependencies...\n")
  local luarocks = install_dir .. "/bin/luarocks"

  local deps = {
    {"luasocket", config.versions.luasocket, openssl_flags},
    {"luasec", config.versions.luasec, openssl_flags},
    {"luaossl", config.versions.luaossl, openssl_flags},
    {"luaposix", config.versions.luaposix, openssl_flags},
    {"dkjson", config.versions.dkjson, ""},
    {"luafilesystem", config.versions.luafilesystem, ""},
    {"compat53", config.versions.compat53, ""},
    {"lpeg", config.versions.lpeg, ""},
    {"lpeg_patterns", config.versions.lpeg_patterns, ""},
    {"binaryheap", config.versions.binaryheap, ""},
    {"cqueues", config.versions.cqueues, openssl_flags},
    {"http", config.versions.http, ""},
    {"lsqlite3", config.versions.lsqlite3, sqlite_flags},
    {"serpent", config.versions.serpent, ""},
  }

  for _, dep in ipairs(deps) do
    local name, version, flags = dep[1], dep[2], dep[3]
    util.exec(string.format("%s install %s %s %s", luarocks, name, version, flags))
  end

  util.printf("fixing luarocks shebangs for relocatable installation...\n")
  for _, script in ipairs({"luarocks", "luarocks-admin"}) do
    local script_path = install_dir .. "/bin/" .. script
    if util.file_exists(script_path) then
      local content = util.read_file(script_path)
      content = content:gsub(
        "^#!" .. install_dir:gsub("[%-%.%+%[%]%(%)%$%^%%%?%*]", "%%%1") .. "/bin/luajit",
        "#!/usr/bin/env luajit"
      )
      util.write_file(script_path, content)
    end
  end

  util.printf("stripping binaries...\n")
  util.exec("find " .. install_dir .. " -type f -executable -exec strip --strip-unneeded {} \\; 2>/dev/null", {allow_failure = true})

  local platform_dir = config.output_dir .. "/" .. config.platform.platform
  util.mkdir_p(platform_dir)

  local binary_name = string.format("luajit-%s-%s-%s", config.build_date, config.commit_hash, config.platform.platform)
  local tarball_name = binary_name .. ".tar.gz"

  util.printf("packaging binary as %s...\n", tarball_name)

  local staging_dir = config.temp_dir .. "/staging"
  util.mkdir_p(staging_dir .. "/" .. binary_name)

  for _, dir in ipairs({"bin", "lib", "share", "include"}) do
    util.exec(string.format("cp -R %s/%s %s/%s/", install_dir, dir, staging_dir, binary_name))
  end

  local tarball_path = platform_dir .. "/" .. tarball_name

  util.create_tarball(staging_dir, binary_name, tarball_path, config.platform, source_date_epoch)

  util.exec(string.format(
    "cd %s && ln -sf %s luajit-latest-%s.tar.gz",
    platform_dir, tarball_name, config.platform.platform
  ))

  util.printf("calculating sha256...\n")
  local checksum = util.calculate_sha256(tarball_path)

  util.printf("testing binary...\n")
  local luajit_bin = install_dir .. "/bin/luajit"
  util.exec(luajit_bin .. " -v")
  util.exec(luajit_bin .. " -e \"print('luajit test successful')\"")
  util.exec(luajit_bin .. " -e \"require('socket'); require('ssl'); print('luasocket and luasec loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('openssl'); print('luaossl loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('posix'); print('luaposix loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('dkjson'); print('dkjson loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('lfs'); print('luafilesystem loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('http.client'); print('lua-http loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('lsqlite3'); print('lsqlite3 loaded successfully')\"")
  util.exec(luajit_bin .. " -e \"require('serpent'); print('serpent loaded successfully')\"")

  util.printf("listing tarball contents...\n")
  util.exec(string.format("tar -tvzf %s | head -50", tarball_path))

  local size = util.capture("du -h " .. luajit_bin .. " | cut -f1")
  util.printf("binary size: %s\n", size)

  if util.exec("command -v ldd >/dev/null 2>&1", {quiet = true, allow_failure = true}) then
    util.printf("dynamic libraries:\n")
    util.exec("ldd " .. luajit_bin, {allow_failure = true})
  end

  util.printf("cleaning up...\n")
  util.exec("rm -rf " .. config.temp_dir)

  util.printf("build complete!\n")
  util.printf("tarball: %s/%s\n", platform_dir, tarball_name)
  util.printf("sha256: %s\n", checksum)
end

local function main()
  local script_dir = arg[0]:match("^(.*/)") or "./"
  local workspace_root = util.capture(string.format("cd %s../../ && pwd", script_dir))

  local temp_dir = util.capture("mktemp -d")
  local output_dir = os.getenv("OUTPUT_DIR") or (workspace_root .. "/dist/luajit")

  local config = {
    versions = versions,
    temp_dir = temp_dir,
    output_dir = output_dir,
    platform = util.detect_platform(),
  }

  local ok, err = pcall(function()
    build_luajit(config)
  end)

  if not ok then
    util.errorf("build failed: %s\n", err)
  end
end

main()
