#!/bin/bash

source "$(dirname "$0")/env"

# Detect platform and architecture
os=$(uname -s | tr '[:upper:]' '[:lower:]')
arch=$(uname -m)

luajit_version="2025.10.16-25a61a18"
release_tag="2025.12.02-c993cc1"

case "$os-$arch" in
linux-x86_64)
  url="https://github.com/whilp/dotfiles/releases/download/${release_tag}/luajit-${luajit_version}-linux-x64.tar.gz"
  expected_sha256="60d43c1b20e75561ab338f7c91b3ed0945f58cc725ca16991c063bf66d8321c2"
  ;;
linux-aarch64 | linux-arm64)
  url="https://github.com/whilp/dotfiles/releases/download/${release_tag}/luajit-${luajit_version}-linux-arm64.tar.gz"
  expected_sha256="53efb033dfca07672ab6dae56a3ee3bf99989bf806407ce9570d787967d74082"
  ;;
darwin-arm64)
  url="https://github.com/whilp/dotfiles/releases/download/${release_tag}/luajit-${luajit_version}-darwin-arm64.tar.gz"
  expected_sha256="b91254d85fa599a3de65b210e4c1bcb0799fb6e777fd8ed490cde55d12e7bfae"
  ;;
*)
  echo "Unsupported platform: $os-$arch" >&2
  exit 1
  ;;
esac

# Create bootstrap directory structure
bootstrap_dir="$DST/.local/bootstrap"
mkdir -p "$bootstrap_dir"/{bin,lib}

# Create temporary directory for download
temp_dir=$(mktemp -d)
archive="$temp_dir/luajit.tar.gz"

# Download LuaJIT
echo "Bootstrapping LuaJIT from $url" >&2
curl -fsSL -o "$archive" "$url"

# Verify checksum
actual_sha256=$(shasum -a 256 "$archive" | cut -d' ' -f1)
if [ "$actual_sha256" != "$expected_sha256" ]; then
  echo "Checksum mismatch for $archive" >&2
  echo "  expected: $expected_sha256" >&2
  echo "  actual:   $actual_sha256" >&2
  rm -rf "$temp_dir"
  exit 1
fi

# Extract to bootstrap location
tar -xzf "$archive" -C "$bootstrap_dir"

# Find the extracted directory (it will have the version in the name)
luajit_dir=$(find "$bootstrap_dir" -maxdepth 1 -type d -name "luajit-*" | head -n1)

# Create symlinks in bootstrap/bin
ln -sf "$luajit_dir/bin/luajit" "$bootstrap_dir/bin/luajit"
ln -sf "$luajit_dir/bin/luajit" "$bootstrap_dir/bin/lua-shimlink"
ln -sf "$luajit_dir/bin/luajit" "$bootstrap_dir/bin/lua"

# Copy lib and share directories to bootstrap if they exist
if [ -d "$luajit_dir/lib" ]; then
  cp -r "$luajit_dir/lib"/* "$bootstrap_dir/lib/"
fi

if [ -d "$luajit_dir/share" ]; then
  mkdir -p "$bootstrap_dir/share"
  cp -r "$luajit_dir/share"/* "$bootstrap_dir/share/"
fi

# Clean up
rm -rf "$temp_dir"

echo "Bootstrapped LuaJIT in $bootstrap_dir" >&2
