#!/bin/bash

source "$(dirname "$0")/env"

if [ "${CODESPACES}" = "true" ]; then
  CLAUDE_VERSION="2.0.67"
  CLAUDE_SHA256="b2a12279d5df3814f59000682a571edb771b73e89b4bd894101f01e3726726f3"
  CLAUDE_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/${CLAUDE_VERSION}/linux-x64/claude"
  CLAUDE_BIN="$DST/.local/share/claude/bin/claude"

  (
    mkdir -p "$(dirname "$CLAUDE_BIN")"
    curl -fsSL -o "$CLAUDE_BIN" "$CLAUDE_URL"
    echo "${CLAUDE_SHA256}  $CLAUDE_BIN" | sha256sum -c -
    chmod +x "$CLAUDE_BIN"
  ) &
fi

config="$DST/.claude.json"
[ -r "$config" ] && exit 0

if [ -n "${CLAUDE_CREDENTIALS}" ]; then
  echo "${CLAUDE_CREDENTIALS}" >"$DST/.claude/.credentials.json"
fi

settings='{
  "numStartups": 1,
  "installMethod": "unknown",
  "autoUpdates": false,
  "theme": "dark-daltonized",
  "hasCompletedOnboarding": true,
  "bypassPermissionsModeAccepted": true
}'
echo "$settings" >"$config"

wait
