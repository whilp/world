id: use-cosmo-is-main
language: lua
severity: error
message: |
  Avoid fragile main guard patterns. Use cosmo.is_main() instead.

  Example:
    Bad:  if not pcall(debug.getlocal, 4, 1) then main() end
    Bad:  if arg[0]:match("script.lua$") then main() end
    Good: if cosmo.is_main() then main() end
note: cosmo.is_main() is a C function that reliably detects main script in both cosmos and cosmic.

rule:
  any:
    - pattern: pcall(debug.getlocal, $$$)
    - pattern: arg[0]:match($$$)
