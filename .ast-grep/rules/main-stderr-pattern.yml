id: main-stderr-pattern
language: lua
severity: hint
message: |
  Consider avoiding io.stderr:write() in main() - accept opts.stderr for testability.

  main() functions should accept configurable output:
    Bad:  io.stderr:write("error\n")
    Good: opts.stderr:write("error\n")
    Good: return 1, "error message"

  Exceptions:
    - Debug logging in conditional blocks
    - Scripts that don't need unit testing
note: |
  For testable main() functions:
  1. Accept an opts parameter with stderr/stdout streams
  2. Use opts.stderr instead of io.stderr
  3. Or return errors and let the caller handle output

  This is a hint for manual review, not a hard rule.

rule:
  pattern: io.stderr:write($$$ARGS)
  inside:
    any:
      - pattern: local function main($$$PARAMS) $$$BODY end
      - pattern: function main($$$PARAMS) $$$BODY end
