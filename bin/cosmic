#!/bin/sh
set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
COSMIC_LUA="${SCRIPT_DIR}/cosmic-lua"
RELEASE_URL="https://github.com/whilp/world/releases/download/home-2026-01-04-7a278f2/cosmic-lua"

# Download cosmic-lua if it doesn't exist
if [ ! -f "${COSMIC_LUA}" ]; then
    echo "Downloading cosmic-lua..." >&2
    curl -fsSL -o "${COSMIC_LUA}" "${RELEASE_URL}"
    chmod +x "${COSMIC_LUA}"
fi

# Handle bootstrap mode: just ensure binary exists and update PATH
if [ "${BOOTSTRAP}" = "1" ]; then
    if [ -n "${CLAUDE_ENV_FILE}" ]; then
        echo "export PATH=\"${SCRIPT_DIR}:\$PATH\"" >> "${CLAUDE_ENV_FILE}"
    fi
    exit 0
fi

# Set LUA_PATH to include project's lib directory
export LUA_PATH="${PROJECT_DIR}/lib/?.lua;${PROJECT_DIR}/lib/?/init.lua;./?.lua;./?/init.lua;;"

# Execute cosmic-lua with all arguments
exec "${COSMIC_LUA}" "$@"
