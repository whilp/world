#!/usr/bin/env bash
# test-backend: conformance suite for box backends
#
# Usage: test-backend <backend-path>
#
# Tests that a backend implements all required commands correctly.
# Exit code 0 indicates all tests passed, non-zero indicates failure.

set -uo pipefail

backend="${1:-}"
if [[ -z "$backend" ]]; then
  echo "usage: test-backend <backend-path>" >&2
  exit 1
fi

# Validate backend is executable
# If it contains '/', it's a file path - check directly
# Otherwise, it's a command name - use 'which' to find it
if [[ "$backend" == */* ]]; then
  if [[ ! -x "$backend" ]]; then
    echo "error: backend not executable: $backend" >&2
    exit 1
  fi
else
  if ! which "$backend" >/dev/null 2>&1; then
    echo "error: backend not found in PATH: $backend" >&2
    exit 1
  fi
fi

# Test configuration
test_box="test-box-$$"
test_src="/tmp/test-upload-$$"
test_dst="/tmp/test-download-$$"
test_remote_path="/tmp/test-remote-$$"

passed=0
failed=0

# Colors for output
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  RED='\033[0;31m'
  YELLOW='\033[1;33m'
  NC='\033[0m' # No Color
else
  GREEN=''
  RED=''
  YELLOW=''
  NC=''
fi

log() {
  echo -e "${YELLOW}[TEST]${NC} $*" >&2
}

pass() {
  echo -e "${GREEN}[PASS]${NC} $*" >&2
  ((passed++))
}

fail() {
  echo -e "${RED}[FAIL]${NC} $*" >&2
  ((failed++))
}

# Test: list command exists
test_list() {
  log "Testing list command"
  if "$backend" list >/dev/null 2>&1; then
    pass "list command succeeded"
  else
    fail "list command failed"
  fi
}

# Test: new command
test_new() {
  log "Testing new command"
  if "$backend" new "$test_box" >/dev/null 2>&1; then
    pass "new command succeeded"
  else
    fail "new command failed"
  fi
}

# Test: exec command
test_exec() {
  log "Testing exec command"
  if "$backend" exec "$test_box" "echo test" >/dev/null 2>&1; then
    pass "exec command succeeded"
  else
    fail "exec command failed (box may not exist yet)"
  fi
}

# Test: upload command
test_upload() {
  log "Testing upload command"
  echo "test content" > "$test_src"

  if "$backend" upload "$test_box" "$test_src" "$test_remote_path" >/dev/null 2>&1; then
    pass "upload command succeeded"
    rm -f "$test_src"
  else
    fail "upload command failed"
    rm -f "$test_src"
  fi
}

# Test: download command
test_download() {
  log "Testing download command"

  if "$backend" download "$test_box" "$test_remote_path" "$test_dst" >/dev/null 2>&1; then
    pass "download command succeeded"
    rm -f "$test_dst"
  else
    fail "download command failed"
    rm -f "$test_dst"
  fi
}

# Test: destroy command
test_destroy() {
  log "Testing destroy command"
  if "$backend" destroy "$test_box" >/dev/null 2>&1; then
    pass "destroy command succeeded"
  else
    fail "destroy command failed"
  fi
}

# Test: ssh command exists (can't test interactively)
test_ssh_exists() {
  log "Testing ssh command exists"
  # Just verify the command doesn't immediately fail with "unknown command"
  if "$backend" ssh "$test_box" 2>&1 | grep -qi "unknown command"; then
    fail "ssh command not recognized"
  else
    pass "ssh command exists"
  fi
}

# Test: invalid command returns error
test_invalid_command() {
  log "Testing invalid command returns error"
  "$backend" invalid-command 2>/dev/null && fail "invalid command did not return error" || pass "invalid command returned error as expected"
}

# Test: commands that require arguments fail without them
test_missing_args() {
  log "Testing commands fail gracefully with missing arguments"

  local cmds_passed=0

  # new without name
  "$backend" new 2>/dev/null && fail "new without arguments should fail" || cmds_passed=$((cmds_passed + 1))

  # exec without name or command
  "$backend" exec 2>/dev/null && fail "exec without arguments should fail" || cmds_passed=$((cmds_passed + 1))

  # upload without arguments
  "$backend" upload 2>/dev/null && fail "upload without arguments should fail" || cmds_passed=$((cmds_passed + 1))

  # download without arguments
  "$backend" download 2>/dev/null && fail "download without arguments should fail" || cmds_passed=$((cmds_passed + 1))

  # destroy without name
  "$backend" destroy 2>/dev/null && fail "destroy without arguments should fail" || cmds_passed=$((cmds_passed + 1))

  if [[ $cmds_passed -eq 5 ]]; then
    pass "all commands fail gracefully with missing arguments"
  fi
}

# Run all tests
echo "==> Running conformance tests for: $backend"
echo ""

test_invalid_command
test_missing_args
test_list
test_new
test_exec
test_upload
test_download
test_destroy
# Note: ssh test is minimal since we can't test interactive behavior
test_ssh_exists

# Summary
echo ""
echo "==> Test Summary"
echo "Passed: $passed"
echo "Failed: $failed"

if [[ $failed -eq 0 ]]; then
  echo -e "${GREEN}All tests passed!${NC}"
  exit 0
else
  echo -e "${RED}Some tests failed${NC}"
  exit 1
fi
