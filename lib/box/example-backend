#!/usr/bin/env bash
# example-backend: minimal backend for box --exe
#
# This script demonstrates the interface required for box executable backends.
# Each backend must implement these subcommands:
#   new <name> [args...]     - Create a new box
#   ssh <name> [args...]     - Connect to box via SSH
#   exec <name> <cmd>        - Execute command on box
#   upload <name> <src> <dst> - Upload file to box
#   download <name> <src> <dst> - Download file from box
#   destroy <name>           - Destroy box
#   list                     - List all boxes
#
# Exit code 0 indicates success, non-zero indicates failure.
# Error messages should be written to stderr.

set -u

cmd="${1:-}"
shift || true

case "$cmd" in
  new)
    name="${1:-}"
    if [[ -z "$name" ]]; then
      echo "error: new requires box name" >&2
      exit 1
    fi
    shift
    # Create a new box - for demo, just echo
    echo "Creating box: $name with args: $*" >&2
    # In a real backend, you would:
    # - Call cloud provider API to create instance
    # - Wait for instance to be ready
    # - Return 0 on success
    exit 0
    ;;

  ssh)
    name="${1:-}"
    if [[ -z "$name" ]]; then
      echo "error: ssh requires box name" >&2
      exit 1
    fi
    shift
    # Connect to box via SSH - for demo, just echo
    echo "SSHing to box: $name with args: $*" >&2
    # In a real backend, you would:
    # - If $1 is provided (shell from box), exec ssh user@host "$1"
    # - Otherwise, exec ssh user@host (uses remote default shell)
    # Note: use exec to replace this process with ssh
    exit 0
    ;;

  exec)
    name="${1:-}"
    cmd_to_run="${2:-}"
    if [[ -z "$name" ]] || [[ -z "$cmd_to_run" ]]; then
      echo "error: exec requires box name and command" >&2
      exit 1
    fi
    # Execute command on box - for demo, just echo
    echo "Executing on $name: $cmd_to_run" >&2
    # In a real backend, you would:
    # - ssh user@host -- bash -c "$cmd_to_run"
    # - Pass through stdout/stderr
    exit 0
    ;;

  upload)
    name="${1:-}"
    src="${2:-}"
    dst="${3:-}"
    if [[ -z "$name" ]] || [[ -z "$src" ]] || [[ -z "$dst" ]]; then
      echo "error: upload requires box name, source, and destination" >&2
      exit 1
    fi
    # Upload file to box - for demo, just echo
    echo "Uploading $src to $name:$dst" >&2
    # In a real backend, you would:
    # - scp "$src" "user@host:$dst"
    # - Or use cloud provider's copy mechanism
    exit 0
    ;;

  download)
    name="${1:-}"
    src="${2:-}"
    dst="${3:-}"
    if [[ -z "$name" ]] || [[ -z "$src" ]] || [[ -z "$dst" ]]; then
      echo "error: download requires box name, source, and destination" >&2
      exit 1
    fi
    # Download file from box - for demo, just echo
    echo "Downloading $name:$src to $dst" >&2
    # In a real backend, you would:
    # - scp "user@host:$src" "$dst"
    # - Or use cloud provider's copy mechanism
    exit 0
    ;;

  destroy)
    name="${1:-}"
    if [[ -z "$name" ]]; then
      echo "error: destroy requires box name" >&2
      exit 1
    fi
    # Destroy box - for demo, just echo
    echo "Destroying box: $name" >&2
    # In a real backend, you would:
    # - Call cloud provider API to delete instance
    # - Wait for deletion to complete
    exit 0
    ;;

  list)
    # List all boxes - for demo, just echo
    echo "box1"
    echo "box2"
    # In a real backend, you would:
    # - Call cloud provider API to list instances
    # - Print one box name per line
    exit 0
    ;;

  *)
    echo "error: unknown command: $cmd" >&2
    echo "usage: $0 {new|ssh|exec|upload|download|destroy|list}" >&2
    exit 1
    ;;
esac
