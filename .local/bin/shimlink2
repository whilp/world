#!/usr/bin/env luajit

package.path = os.getenv("HOME") .. "/.local/lib/lua/?.lua;" .. package.path
local version = require("version")

local function config_dir()
  return os.getenv("HOME") .. "/.config/shimlink2"
end

local function config_path(executable)
  return config_dir() .. "/" .. executable .. ".lua"
end

local function load_config(executable)
  return version.load(config_path(executable))
end

local function build_context(config, platform, platform_data)
  local base = {
    destination = os.getenv("HOME") .. "/.local/share/shimlink/bin",
  }
  for k, v in pairs(config) do
    if k ~= "platforms" and k ~= "urls" then
      base[k] = v
    end
  end
  return version.merge(base, platform_data or {}, {platform = platform})
end

local function expand_templates(config)
  local base_context = {
    destination = os.getenv("HOME") .. "/.local/share/shimlink/bin",
  }
  for k, v in pairs(config) do
    if k ~= "platforms" and k ~= "urls" then
      base_context[k] = v
    end
  end

  for k, v in pairs(config) do
    if k ~= "platforms" and k ~= "urls" and k ~= "url" then
      config[k] = version.expand(v, base_context)
    end
  end

  local expanded = {}
  for platform, platform_data in pairs(config.platforms) do
    local context = build_context(config, platform, platform_data)
    expanded[platform] = version.expand(platform_data, context)
  end

  config.platforms = expanded

  if config.url then
    config.urls = {}
    for platform, platform_data in pairs(config.platforms) do
      local context = build_context(config, platform, platform_data)
      config.urls[platform] = version.interpolate(config.url, context)
    end
  end

  return config
end

local function parse_params(args)
  local params = {}
  for _, arg in ipairs(args) do
    local key, value = arg:match("^([^=]+)=(.+)$")
    if key and value then
      params[key] = value
    end
  end
  return params
end

local function set_nested(tbl, path, value)
  local keys = {}
  for key in path:gmatch("[^.]+") do
    table.insert(keys, key)
  end

  local current = tbl
  for i = 1, #keys - 1 do
    local key = keys[i]
    if not current[key] then
      current[key] = {}
    end
    current = current[key]
  end

  current[keys[#keys]] = value
end

local function apply_updates(config, params)
  local platform = params.platform
  local version = params.version
  local sha = params.sha

  if version then
    config.version = version
  end

  if platform and sha then
    if not config.platforms[platform] then
      config.platforms[platform] = {}
    end
    config.platforms[platform].sha256 = sha
  end

  for key, value in pairs(params) do
    if key ~= "platform" and key ~= "version" and key ~= "sha" then
      set_nested(config, key, value)
    end
  end

  return config
end

local function cmd_show(args)
  if #args < 1 then
    error("usage: shimlink2 show <executable> [key=value...]")
  end

  local executable = args[1]
  local params = parse_params({unpack(args, 2)})

  local config = load_config(executable)
  config = apply_updates(config, params)
  config = expand_templates(config)

  print(version.render(config))
end

local function cmd_write(args)
  if #args < 1 then
    error("usage: shimlink2 write <executable> [key=value...]")
  end

  local executable = args[1]
  local params = parse_params({unpack(args, 2)})

  local config = load_config(executable)
  config = apply_updates(config, params)

  local rendered = version.render(config, {exclude = {"urls"}})

  local path = config_path(executable)
  local f = io.open(path, "w")
  if not f then
    error("failed to open file for writing: " .. path)
  end
  f:write(rendered)
  f:close()

  print("updated " .. path)
  if params.version then
    print("  version: " .. params.version)
  end
  if params.platform and params.sha then
    print("  " .. params.platform .. ": " .. params.sha:sub(1, 16) .. "...")
  end
end

local function cmd_help()
  print([[shimlink2 - experimental serpent-based config manager

usage:
  shimlink2 show <executable> [key=value...]
    show config with optional updates applied (does not persist)

  shimlink2 write <executable> [key=value...]
    update config and persist to disk

special parameters:
  platform=X  - target platform for sha updates
  version=Y   - update version (regenerates all URLs)
  sha=Z       - update sha256 for platform (requires platform=)

examples:
  shimlink2 show mivn
  shimlink2 show mivn version=2025.11.24
  shimlink2 write mivn platform=darwin-arm64 version=2025.11.24 sha=abc123...
  shimlink2 write mivn version=2025.11.24
]])
end

local function main(args)
  if #args == 0 or args[1] == "help" or args[1] == "--help" then
    cmd_help()
    os.exit(0)
  end

  local command = args[1]
  local cmd_args = {unpack(args, 2)}

  if command == "show" then
    cmd_show(cmd_args)
  elseif command == "write" then
    cmd_write(cmd_args)
  else
    error("unknown command: " .. command)
  end
end

local args = {...}
local ok, err = pcall(main, args)
if not ok then
  io.stderr:write("error: " .. tostring(err) .. "\n")
  os.exit(1)
end
