#!/usr/bin/env lua

local cosmo = require("cosmo")
local unix = cosmo.unix
local path = cosmo.path

local script_dir = path.dirname(path.dirname(path.dirname(debug.getinfo(1, "S").source:sub(2))))
package.path = script_dir .. "/src/?.lua;" .. script_dir .. "/src/?/init.lua;" .. package.path

local environ = require("environ")

local invoked_as = path.basename(arg[0])
local env = environ.new(unix.environ())

local handlers = {
  gh = function(env)
    if not env.USE_GH_HOST then
      env.GH_HOST = nil
    end
  end,
  ghc = function(env)
    env.GH_HOST = "github.com"
  end,
}

local handler = handlers[invoked_as]
if handler then
  handler(env)
end

local function find_gh_binary()
  local home = os.getenv("HOME")
  local gh_dir = path.join(home, ".local", "share", "gh")

  local dir = unix.opendir(gh_dir)
  local versions = {}

  for entry in dir do
    if entry ~= "." and entry ~= ".." then
      table.insert(versions, entry)
    end
  end

  table.sort(versions)
  local latest = versions[#versions]

  if latest then
    return path.join(gh_dir, latest, "bin", "gh")
  end

  error("could not find gh binary in ~/.local/share/gh")
end

local gh_bin = find_gh_binary()
local args = {"gh", ...}
unix.execve(gh_bin, args, env:toarray())
