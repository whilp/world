#!/usr/bin/env lua
-- luacheck ignore: script runtime

local posix = require('posix')
local unistd = require('posix.unistd')
local wait = require('posix.sys.wait')

-- Build comrak command with arguments
local args = {"comrak", "--to", "commonmark", "--gfm", "--width", "0", "--front-matter-delimiter", "---"}
for i = 1, #arg do
    table.insert(args, arg[i])
end

-- Run comrak and capture output
local handle = posix.popen(args, "r")
local output = unistd.read(handle.fd, 65536) or ""
local _, reason, exit_code = wait.wait(handle.pids[1])
unistd.close(handle.fd)

if reason ~= "exited" or exit_code ~= 0 then
    os.exit(exit_code or 1)
end

-- Fix space after triple backticks with language info
output = output:gsub("^``` (.+)", "```%1"):gsub("\n``` (.+)", "\n```%1")

-- Write to stdout
io.write(output)
