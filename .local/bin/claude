#!/usr/bin/env lua

local unistd = require("posix.unistd")
local glob = require("posix.glob")

local HOME = os.getenv("HOME")

local claude_patterns = {
  "/*/deploy/claude-wrapper-hosts/current/bin/claude",
  "/usr/local/bin/claude",
  HOME .. "/.local/share/shimlink/bin/claude",
}

local claude_bin = nil
for _, pattern in ipairs(claude_patterns) do
  local matches = glob.glob(pattern, 0)
  if matches and #matches > 0 then
    claude_bin = matches[1]
    break
  end
end

if not claude_bin then
  io.stderr:write("claude wrapper: no claude binary found in configured paths\n")
  os.exit(1)
end

local argv = {
  "--dangerously-skip-permissions",
  "--strict-mcp-config",
  "--append-system-prompt",
  [[INSTRUCTION: Review available skills and pick at least one that is relevant to the user's request. Activate it with Skill(<skillname>).]],
}

for i = 1, #arg do
  table.insert(argv, arg[i])
end

local result, err = unistd.execp(claude_bin, argv)

io.stderr:write("claude wrapper: failed to exec claude: " .. tostring(err) .. "\n")
os.exit(1)
