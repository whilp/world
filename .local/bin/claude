#!/usr/bin/env lua

local unistd = require("posix.unistd")
local glob = require("posix.glob")

local HOME = os.getenv("HOME")

local claude_patterns = {
  "/*/deploy/claude-wrapper-hosts/current/bin/claude",
  "/usr/local/bin/claude",
  HOME .. "/.local/share/shimlink/bin/claude",
}

local claude_bin = nil
for _, pattern in ipairs(claude_patterns) do
  local matches = glob.glob(pattern, 0)
  if matches and #matches > 0 then
    claude_bin = matches[1]
    break
  end
end

if not claude_bin then
  io.stderr:write("claude wrapper: no claude binary found in configured paths\n")
  os.exit(1)
end

local skills_dir = HOME .. "/.claude/skills"
local skill_names = {}
local skills = glob.glob(skills_dir .. "/*", 0)
if skills then
  for _, skill_path in ipairs(skills) do
    local name = skill_path:match("([^/]+)$")
    if name then
      table.insert(skill_names, name)
    end
  end
end

local skill_instruction =
  "INSTRUCTION: After the user supplies a prompt, you MUST IMMEDIATELY activate at least one skill with Skill(<skillname>) that is relevant to the user's request."
if #skill_names > 0 then
  skill_instruction = skill_instruction .. " Available user skills: " .. table.concat(skill_names, ", ")
end

local append_prompts = { skill_instruction }
local env_append = os.getenv("CLAUDE_APPEND_SYSTEM_PROMPT")
if env_append then
  table.insert(append_prompts, env_append)
end

local argv = {
  "--dangerously-skip-permissions",
  "--strict-mcp-config",
  "--append-system-prompt",
  table.concat(append_prompts, "\n\n"),
}

for i = 1, #arg do
  table.insert(argv, arg[i])
end

local result, err = unistd.execp(claude_bin, argv)

io.stderr:write("claude wrapper: failed to exec claude: " .. tostring(err) .. "\n")
os.exit(1)
